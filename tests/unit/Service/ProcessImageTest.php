<?php declare(strict_types=1);

use ImageBlur\Service\ProcessImage;
use Spatie\Snapshots\MatchesSnapshots;

final class ProcessImageTest extends WP_Mock\Tools\TestCase {
	/**
	 * Instantiated Process Image class
	 *
	 * @var ProcessImage
	 */
	public $service;

	use MatchesSnapshots;

	public function setUp(): void {
		WP_Mock::setUp();
		$this->service = new ProcessImage();
	}

	public function tearDown(): void {
		WP_Mock::tearDown();
		Mockery::close();
	}

	public function testCanCreateInstanceOfClass() {
		$this->assertInstanceOf( ProcessImage::class, $this->service );
	}

	public function testChooseFuncsForMimeTypeMethod() {
		list( $process, $output ) = $this->service->choose_funcs_for_mime_type( 'unknown/mime' );
		$this->assertNull( $process );
		$this->assertNull( $output );

		list( $process, $output ) = $this->service->choose_funcs_for_mime_type( 'image/png' );
		$this->assertEquals( $process, array( $this->service, 'process_png' ) );
		$this->assertEquals( $output, 'imagepng' );

		list( $process, $output ) = $this->service->choose_funcs_for_mime_type( 'image/jpeg' );
		$this->assertEquals( $process, array( $this->service, 'process_image' ) );
		$this->assertEquals( $output, 'imagejpeg' );

		list( $process, $output ) = $this->service->choose_funcs_for_mime_type( 'image/gif' );
		$this->assertEquals( $process, array( $this->service, 'process_image' ) );
		$this->assertEquals( $output, 'imagegif' );
	}

	public function testDownscaleMethod() {
		WP_Mock::onFilter( 'image-blur-modify-width' )
			->with( 8 )
			->reply( 20 );
			
		$image = imagecreate(400, 600);
		$downscaled_image = $this->service->downscale( $image );

		$width = imagesx($downscaled_image);
		$height = imagesy($downscaled_image);
		
		$this->assertEquals($width, 20);
		$this->assertEquals($height, 30);
	}

	public function testGaussianBlurMethod() {
		$strength = 10;

		WP_Mock::onFilter( 'image-blur-modify-gaussian-blur-strength' )
			->with( 1 )
			->reply( $strength );

		$test_image_content = file_get_contents( realpath( __DIR__ . "/../../../tests/assets/test-image-gaussian-blur.jpg") );
		
		$test_image = imagecreatefromstring( $test_image_content );
		$this->service->gaussian_blur( $test_image );

		ob_start();
		imagejpeg( $test_image );
		$test_image_content = ob_get_clean();

		$this->assertEquals( $test_image_content, file_get_contents( __DIR__ . "/../../../tests/assets/test-image-gaussian-blur-$strength.jpg" ) );

		/* $image = "0xffd8ffe000104a46494600010101004800480000fffe003e43524541544f523a2067642d6a7065672076312e3020287573696e6720494a47204a50454720763830292c2064656661756c74207175616c6974790affdb004300080606070605080707070909080a0c140d0c0b0b0c1912130f141d1a1f1e1d1a1c1c20242e2720222c231c1c2837292c30313434341f27393d38323c2e333432ffdb0043010909090c0b0c180d0d1832211c213232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232ffc000110800b4014003012200021101031101ffc4001f0000010501010101010100000000000000000102030405060708090a0bffc400b5100002010303020403050504040000017d01020300041105122131410613516107227114328191a1082342b1c11552d1f02433627282090a161718191a25262728292a3435363738393a434445464748494a535455565758595a636465666768696a737475767778797a838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae1e2e3e4e5e6e7e8e9eaf1f2f3f4f5f6f7f8f9faffc4001f0100030101010101010101010000000000000102030405060708090a0bffc400b51100020102040403040705040400010277000102031104052131061241510761711322328108144291a1b1c109233352f0156272d10a162434e125f11718191a262728292a35363738393a434445464748494a535455565758595a636465666768696a737475767778797a82838485868788898a92939495969798999aa2a3a4a5a6a7a8a9aab2b3b4b5b6b7b8b9bac2c3c4c5c6c7c8c9cad2d3d4d5d6d7d8d9dae2e3e4e5e6e7e8e9eaf2f3f4f5f6f7f8f9faffda000c03010002110311003f00dcf83dff001e55ebe5c28c938af1ef83cdfe855e83e2ad41f4fd264990e081401b66ee11d5c7e747db21ff009e8bf9d7cb9a9fc52d4a2bc911646c03eb5447c56d541ff5adf9d007d662e236e8c0d666ada445aa5bb46fdc57ce561f17efa371e63923eb5e97e17f8a96ba832473380c7d4d0072be36f85ae0493db293debc5752d2ee34db868e542307d2bedc8a6b5d52db20abab0af2cf889f0f62bbb792e2de31bb19e05007ccf455dd4f4f974fba78a452306a9500156f4eb53777b1c43b9c554adaf0c0ceb507fbc2803dcbc2df0ce09f4859241cb2e6bcdbe22784868774c53a66be9bf0ba81a243c7f08af1cf8d6a339a00f04a283d68a0028a28a0028a5552cc00ea6baad1fc11a86ab0f991c6c47d280394a2b6b5af0e5de8d2159908fa8ac5a0028a28a0096de06b8996351c938af51d03e15dc6a5602720f2335e6fa44cb06a313b740c2beb7f87f7d05e68910403851401f33f8abc1b73a04c7729dbeb5c957d53f157448ae34a925083207a57cb9731f9570e9e868021a28ab5a7d93df5d24283258e2802ad183e95ecda27c2096f6d125718dc335aff00f0a4e803c0b07d28c1f4af7dff00852747fc293a00f02c1f4a315efbff000a4eabdcfc15758c941cd00785515d7f89bc0f79a1bb168ced1df15c89041c1eb400945145007d2ff074e6d2bb8f1e0ff890cdfee9ae0be0db7fa362bbff001c0ce8337fba6803e3dd63fe42537fbc6a8568eb431aa4dfef1acea002acda5ecd672abc6e411ef55a8a00f74f86ff00111c491dadcc9edc9af77478754b1cf0cac2be1eb0bc92cae9254620835f4d7c2ef168d46c92091f2c06393401c5fc56f06790ef770c7c75e05788ba1472a7a8afb57c59a4c7aa6912a9504ed35f23f8af4b6d33569632b81b8d006056d785ff00e43507fbc2b16b6bc2ff00f21a83fde1401f62f863fe4090ff00b82bc77e3657b17863fe4090ff00b82bc77e365007811ea68a0f534500145145005cd310497f129e85857d69f0ff004bb74d0a23e5ae4a8ed5f27e8c33a9c3fef0afb03c0a31a0c3fee8a00f37f8c7a6c11da9915003f4af9e186188f7afa47e33b7fa1115f37bfdf3f5a006d1451400e8ced9148f5afa5be0dddb49a7aa13dabe681d457d07f05a70620b9a00f49f1e4225d066e3f84d7c83ac26cd4a61fed1afb2bc5d1f9ba1cc31fc26be3df11c663d626047f11a00c8aeabc091ac9afc21867e615cad75be01ff0090fc3fef0a00faf3458923d362c003e514b77ac59d9b6d964553ef4ba671a5c7feed7827c5ad66eecf502b14aca33d8d007b7ffc24fa67fcf78ff3a3fe127d33fe7bc7f9d7c75ff0946a5ff3f0ff009d1ff0946a5ff3f0ff009d007d8bff00093e99ff003de3fceaddaeab677dc44eadf4af8bff00e128d4bfe7e1ff003af4ef859e29b8975258a7989c9ee6803d7bc75e1f8350d2256f2c160a7b57c97ae599b2d4e58b18c31afb66ee3177a630ebb96be50f895a51b2d6e56db804d0070745145007d1df069bf718af46f1a8ce8537fba6bccfe0c37eef15e9fe3119d0a6ff0074d007c77ae8c6ab37fbc6b32b57c4031ab4dfef1acaa0028a28a002bbff0086badbd86b11a17c2935c0569e833983558581c7cc2803ed7b3956f74c56ea196be74f8c1a30b7bf699571935eebe0ab9371a14249fe115e77f19ed14d997c73401f37d6d785ff00e43507fbc2b19c61c8f7ad9f0bff00c86a0ff785007d8be18ff90243fee0af1df8d95ec5e18ff90243fee0af1df8d9401e047a9a283d4d140051451401a7a0aeed5611fed0afb07c14bb74287fdd15f20f870675787fde15f61f84576e870ffba2803cc7e343ff00a3115f3ab7de35f41fc6a7fdd115f3e1ea680128a28a002bd9fe0cdf6cbc11e6bc62bd37e12cc5359419ef401f4d6af189f49907aad7c83e3ab6fb3ebd30c7f11afb0e61bf4c3fee57c9ff00136209af4bfef1a00e0ebadf00ff00c87e1ff7857255d6f807fe43f0ff00bc2803ebdd37fe4149fee57cebf197fe4247eb5f4569bff20a4ff72be75f8cbff2123f5a00f1fa28a2800aeb3c0571243aec3b09fbc2b93af47f85fa2497babc72ed3806803ea1d29cc9a5465baedaf9f3e33448b7a480339afa1e25169a68078dab5f327c5bd4d6e75574539c1a00f2ea28a2803e82f82ed915eb3e2d19d0e6ff0074d7907c156f9b15ec5e2819d126ff0074d007c71e2418d626ff0078d6456d78a0635a9ffde358b400514514005696870b4daa42aa33f30ace00b1c01cd7a67c34f094d7fa8c73bc676839e45007d09e08b7683428430c7ca2b81f8cd70a2c4a679af58b58534fd3957a055af9dbe2febab7378d0236706803c7df973f5ad8f0bffc86a0ff0078562f7adaf0bffc86a0ff00785007d8be18ff0090243fee0af1df8d95ec5e18ff0090243fee0af1df8d9401e047a9a283d4d140051451401b3e1919d660ff007857d89e1618d121ff007457c77e1838d6a0ff007857d89e1739d121ff007450078ffc6b6c0c57811ea6bdf3e358af033d4d001451450015e89f0abfe43b1fd4579dd7a57c268cb6b687de803ea33ff20cff008057cabf1531fdbb27d6beaa97e5d30ffb95f287c4f7ddaf4bf53401c0d75be01ff90fc3fef0ae4abadf00ff00c87e1ff785007d7ba6ff00c8293fdcaf9d7e32ff00c848fd6be8ad37fe4149fee57cebf197fe4247eb401e3f4514f8a269a4088324d0059d3aca4bebb489149c9afa7fe18f85174cd3d269130c467a5703f0c3c08d34b1dd5c47c75e457bf010e9961d955568031fc61ac47a5e91292c01da6be47f13ea4da96ad2c84e46e35e9df157c646e667b5864e3a706bc5dd8bb163d4d00251451401eeff00059bf7b8af69f120ce8b37fba6bc4be0c644fc8af70f100dda34bfeed007c73e2c18d6e7ff0078d61574fe2cb29df5c9b6c6c7e63daa85a786f50bb601207e7da8031ea682d65b870b1a124fb57a0e8bf0bb51bd753246c01f6af58f0cfc27b5b208f3a0247a8a00f28f07fc3abbd4ee239268884cf715f467867c336da1d9a2aa00c0726b4ecf4cb3d2e1011154015cdf8afc6f67a3dab85917781eb400df1d78aa0d234d9144803e3d6be55f106aafaa6a324acc4826b67c61e30b8d72edfe73b33eb5c79e4d0015b5e17ff90d41fef0ac5adaf0bffc86a0ff00785007d8be18ff0090243fee0af1df8d95ec5e18ff0090243fee0af1df8d9401e047a9a283d4d140051451401ade1c6dbabc27fda15f61f845b76870ff00ba2be35d19fcbd4e13fed0afaffc09309741879fe11401e69f1aa226226be7d3d4d7d2bf196d4bd833e3b57cd6e30ec3de801b451450015eb7f076df7ea6ad8ef5e483ad7bb7c16b4cc824c5007ba6a0de5e94fec95f237c429bcdd7a6e7f88d7d61e2297c9d1a53fec9af8f7c5d3f9dadcc73fc4680302badf00ffc87e1ff007857255d6f807fe43f0ffbc2803ebdd37fe4149fee57cebf197fe4247eb5f4569bff0020a8ff00ddaf02f8ada65c6a1abec890b64f61401e2d142f338445249af53f87ff000fa6bfb98e79e33b339e456d7817e17bc8e971771f1d7915ee9a6e976ba45aaaa2aa851400695a65be9162a8aa1428af3bf893e388ec2d64b78641bc8c706b4bc75e3bb7d2ad248a3906fc63835f33f8875e9f58bd791dc904fad0050d4afe4bfbb79646249354e8a2800a28a2803ebdf08f8193c3f26e515db5cdb2dc5b989ba118aa561aed9ea0d8864563ec6b4a495638cbb1c0a00e266f873a74f76669235249cf4ad6b2f0769b698db0271ed524fe2cd3ade528f32823de9abe30d31bfe5e13f3a00d982c20800091a8fc2a72028e0563278a34e7e9709f9d4e9af58c9d274fce8031bc52d7e6dd96d41ce3b578278a3c39e20bd99de412115f4c0beb2987fac43f8d23d9d8dc8c14439a00f8a2f742beb363e6c2c3f0acc65653861835f666ade06d3751898792b93ed5e33e35f85af641e7b64e073c0a00f18adaf0bffc86a0ff00785665ddac9693b47229041ad3f0bffc86a0ff00785007d8be18ff0090243fee0af1df8d95ec5e18ff0090243fee0af1df8d9401e047a9a283d4d1400514514013da3f97751b7a1afabfe16de89f448d73d057c94a76b03e86be87f835ab0680405a803aef8a563f68d1246033815f285e4663ba914f635f6a78aac85f68d2ae339535f20f8aac1ac758990ae06e34018545145003a31ba451ef5f4afc1bb1f2ec16423b57ce5a7c466bd8d00ea457d67f0d34ff00b2687112304ad006978eae45be8331ce3e535f206b52f9da9ccdfed1afa7be2bea02df4674ce322be5d502e752c37466a00759e93777c710c4cdf415dff81bc23a8c1ac432bc2c1411dabd4be1c78534e6d2e399d15988ef5e996fa459dbe0c712823d05003f4e88a58468dd76d67dd786ed2eeefcf963048f515baaa00c0e948fc29c500502d6ba65bff0a2a8af32f1c7c4b82c62921b79016e9c1a93e22dceb0b13ada86dbed5f3a6b2ba835cb35d07ce7bd003f5df105ceb174f24921209f5ac5a28a0028a28a0028a28a00f76f843a9dcdd5d812c8cdf535ee3ac395d2646079db5f3ffc197ff4e03debdff5919d224ff72803e50f18eb77b16b732a4cc06e3deb9e1e23d447fcb77fceb47c70b8d7a6ff0078d731401b89e2ad4d3a4eff009d5a8bc6daac7d277fceb99a2803b6b6f891aac246666fceba5d2be2fdec2ea257247d6bc928a00fabbc2bf136d356291c8e031f535dedc416faa59104065615f13e8fa9cf617b1ba39183eb5f577c3bd69b54d1e32ed92050078cfc54f088d3ee9ee224c2939e0579ff00860635b847fb42be97f8a7a6a5ce8d23ede40af9bb438fcbf11a2fa3ff005a00fafbc31ff20487fdc15e3bf1b2bd8bc31ff20487fdc15e3bf1b2803c08f534507a9a2800a28a2800af43f863aeff00676ad1a3360135e79566c6edecee92543820e6803ee1b49a3d474e52082196bc3be2978164795eeade327bf02b7fe1af8ee2b9b58eda7906e031c9af52b8b5b6d56d8860acac2803e1cb9b496d6529221047ad415f4bf8bbe14c179be5b64018f3c0af1fd57e1dea5657251616233e940143c13a635feb5080b901857d75a0da0b1d2634c630b5e47f0bbc0f259badc5c4783ee2bd8355bb8f4ed31d89002ad007897c66d60126056af09490a4a1c750735d8fc42d68ea5accb86c80c6b8ba00f55f087c4e9346b758646e057a4685f15a3d4ef520079638af98abaef00b1fedf879fe21401f63dacfe75bac9ea3355e6d56da197cb79141f734cd33fe4171ff00bb5e19f13fc4377a56ab98646183d8d007ba4d6d67a847860ae0d717e22f86b61a946ed1c4a18fa0af2ef0cfc5c9e0748ee5c91ee6bd8b41f1e69faac6a3cd5dc7de803c17c51f0bef34e7778632547a0af3cbbd3ee2ce42b2c6c31ea2bee096dacf528790ae08ae07c51f0c6cf51477863018fa0a00f94a8af41f117c36bfd365731c4c547a0ae2ae74dbab5622489863da8029d1410475a2803d73e0e4bb753519ef5f476a237e94ff00ee57cc1f09a7f2f5a419ef5f50cbfbcd30fba5007c85f1023d9afcdfef1ae42bbef89f0797aeca71fc55c0d0014514500145145003a3ff0058bf5afa6fe0eeff00ecc5cfa57ce7a4e9d35f5ec68884e4fa57d5df0e3456d33478f7ae0914016be216dfec09b3fdd35f2ee97ff234ae3fe7a7f5afa37e296a296da2c885b922be6bd125dfe2346f57a00faffc31ff0020487fdc15e39f1aebd87c2c776890e3fba2b83f897e13bad70fee549a00f978f53457a5ff00c2a7d4c9ff0056df951ff0a9b53ff9e6df950079a515e97ff0a9b53ff9e6df95237c27d4c0ff0056df950079ad15d26bbe10bed172658c81f4ae6c8c1c50068e95abdc69770b244e460f635edfe0cf8acbb2382edfdb24d7cff4f8e578983231045007db7a6f88ec353894a4a873ef5725d36c6e8ee68d0fe15f1e68fe34d474b75db33607bd7a169df19678a10b2124d007d0816d74f8495da800af21f89de3a8a2b692d60941278e0d717ae7c5dbabc8592262323d6bccb52d52e3529da499c9c9ee6802bdd5c35cdc348c7249a868a2800aea3c0f32c3af4258e06e15cbd4f6974f693acb19c106803edad2af616d1d1838c6cf5af9d7e305d4736a8c1181e6b32cfe285fdb587d9f79e98eb5c76b1ac4fabdd34b2b1393de80334120e41c56a69baf5ee9d2ab452b0c7bd6551401ed7e13f8b32c0522ba7c8e9c9af67d13c63a7ead12ed95727b66be2e562a72a706b7349f145f6972298e56c0f7a00fb367b1b2d423f995181ae3f5df86da76a11b1489431f415e5de1ff008c1343b12e1891ee6bd77c35e3ab2d6d15448bb8fbd0078178cfe1cdc68eef24484a0f415e73246d139561822beddd6749b5d5ac5d5d54822be58f889a145a4eaae22c019ed4009f0d67f2b5e8b9fe215f5a5b1f334b5f75af8f3c08e535e871fde15f5fe904c9a4c7feed007cd3f176df66aeed8ef5e5b5efbf14fc3177a95f168222d93d8570163f0c754b961ba2603e9401c1004f419ab3069d7370408e263f857b5689f06dc956b85af47d23e1a69b628a5a25247b5007cd763e09d52f08c40d83ed5d7e91f08efae194ca840fa57d1d6fa1e9f68a36c4831ed53b5c58daaf2c8b8a00f3ef0b7c30b5d2d924910161ed5e832c96fa5d99e42aa8ac3d57c6fa6e9d1b1332647bd78e78d7e2a35d2bc16afc1e38340157e2b78b96fae1ede27c8071c1af2bd2ee7ecfa8c7293d1b3515ede4b7b3b4b231249ef5581c1c8a00faefc01e25b5bad2228ccabb828ef5dab5c5a4832cc86be2dd23c557fa4902295801ef5d10f8a3aa85c79adf9d007d5de658faa51e6597aa57c9ff00f0b3f55ff9eadf9d1ff0b3f55ff9eadf9d007d61e6597aa535a5b1c1e52be51ff859faaffcf56fce91be276aa463cd6fce803d5fe2bcda71d39c26cdf8ed5f374b8f35b1d335b3ac789ef75727ce9188fad61d00145145001451450014514500145145001451450014514500145145001451450028247435bde1ff0012dd68d7492248d807d6b028a00f7cb4f8c4a34ed9237cfb715e51e2df1136bb7ed293c135cde4fa9a4a00effe18d8c573ad465c8e0d7d65a7c4b159c68bd00af8c7c21abbe99abc4e1b0370afacbc39afdbdde931c8655cedf5a00dbb8b1b699b32a293ef51882c6dc70a82bcdbc73f11d34772904809f635e5b7ff00173509f211c8fc6803e93b9d6f4fb3525a5418f7ae4f59f89ba758ab0495491e86be6fbff1c6a97a4e666c1f7ac19f50b9b86264958fe3401ed5ac7c657259603fad713a97c4dd4eec90b2b007deb82249ea69280356f75fbebd24c9331cfbd6633b39cb124d368a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a00723b46e194e08aea74ef1cea5a7dbf9292b6318eb5ca51401a5aaeb373aacc6499c9cfa9acda28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a0028a28a00fffd9";
		imagejpeg($image, realpath( __DIR__ . "/../../../tests/assets/test-image-gaussian-blur-foo.jpg")); */
	}

/* 	public function testProcessImageMethod() {
		$mock_image_content = file_get_contents( realpath( __DIR__ . "/../../assets/test-image-process-image.jpg" ) );
		$image = imagecreatefromstring( $mock_image_content );
		$processed_image = $this->service->process_image($image);

		ob_start();
		imagejpeg( $processed_image );
		$mock_image_content = ob_get_contents();
		ob_end_clean();

		$expected_image_content = file_get_contents( realpath( __DIR__ . "/../../assets/test-image-process-image-processed.jpg" ) );
		$this->assertEquals($mock_image_content, $expected_image_content);
	}
	
	public function testProcessPngMethod() {
		$mock_image_content = file_get_contents( realpath( __DIR__ . "/../../assets/test-image-process-png.png" ) );
		$image = imagecreatefromstring( $mock_image_content );
		$processed_image = $this->service->process_png($image);

		ob_start();
		imagepng( $processed_image );
		$mock_image_content = ob_get_contents();
		ob_end_clean();

		$expected_image_content = file_get_contents( realpath( __DIR__ . "/../../assets/test-image-process-png-processed.png" ) );
		$this->assertEquals($mock_image_content, $expected_image_content);

	} */
}
